# Worker Docker Compose Template
# Each worker gets an isolated Harper instance and workspace.
# lab-runner.sh creates a concrete compose file from this template.
#
# Credentials: set HDB_ADMIN_USERNAME and HDB_ADMIN_PASSWORD in your
# environment or in a .env file. See .env.example for defaults.

services:
  harper:
    image: ${HARPER_IMAGE:-harperdb:v5-local}
    environment:
      - HDB_ADMIN_USERNAME=${HDB_ADMIN_USERNAME:-admin}
      - HDB_ADMIN_PASSWORD=${HDB_ADMIN_PASSWORD:?Set HDB_ADMIN_PASSWORD in .env or environment}
      - DEFAULTS_MODE=dev
    ports:
      - "${HARPER_REST_PORT:-9926}:9926"
      - "${HARPER_OPS_PORT:-9925}:9925"
      - "${HARPER_MQTT_PORT:-1883}:1883"
    volumes:
      - harper-data:/home/harperdb/hdb
      - ${COMPONENT_DIR:-./components}:/app/components
    networks:
      - worker-net
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:9925/').then(()=>process.exit(0)).catch(()=>process.exit(1))"]
      interval: 5s
      timeout: 5s
      retries: 12
      start_period: 30s

  workspace:
    image: node:22-slim
    working_dir: /app
    volumes:
      - workspace:/app
      - ../assignments:/assignments:ro
    networks:
      - worker-net
    environment:
      - HARPER_URL=http://harper:9926
      - HARPER_OPS_URL=http://harper:9925
      - HARPER_ADMIN_USERNAME=${HDB_ADMIN_USERNAME:-admin}
      - HARPER_ADMIN_PASSWORD=${HDB_ADMIN_PASSWORD:?Set HDB_ADMIN_PASSWORD in .env or environment}
      - ASSIGNMENT_FILE=/assignments/${ASSIGNMENT_FILE:-tier-1-bookmark-manager.md}
    depends_on:
      harper:
        condition: service_healthy
    # Keep alive for agent to connect
    command: ["tail", "-f", "/dev/null"]

volumes:
  harper-data:
  workspace:

networks:
  worker-net:
    driver: bridge
